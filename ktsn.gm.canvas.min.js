function canvasLayer(n){this.setMap(n)}function handler(n,t){return function(){t(n)}}function getNormalizedCoord(n,t){var u=n.y,i=n.x,r=1<<t;return u<0||u>=r?null:((i<0||i>=r)&&(i=(i%r+r)%r),{x:i,y:u})}canvasLayer.prototype=new google.maps.OverlayView;canvasLayer.prototype.draw=function(){};canvasLayer.prototype.onAdd=function(){for(var n,r,i=this.getPanes().overlayLayer,t=0,u=K._layers.length;t<u;t++)n=document.createElement("canvas"),n.style.position="absolute",i.appendChild(n),K._layers[t]._canvas=n;K._pane=i;this._moveend=google.maps.event.addListener(this.map,"idle",handler(this,K._draw));this._mousemove=google.maps.event.addListener(this.map,"mousemove",K._move);this._click=google.maps.event.addListener(this.map,"click",K._click);n=document.createElement("canvas");n.style.position="absolute";r=this.getPanes();r.overlayImage.appendChild(n)};canvasLayer.prototype.onRemove=function(){var t=K._pane,n,i;for(t.removeChild(this._canvas),n=0,i=K._layers.length;n<i;n++)t.removeChild(K._layers[n]._canvas);google.maps.event.removeListener(this._moveend);this._moveend=null;google.maps.event.removeListener(this._mousemove);this._mousemove=null;google.maps.event.removeListener(this._click);this._click=null};window.K={init:function(n){this._map=n.map?n.map:new google.maps.Map(document.getElementById(n.div),n.options);this._pane=null;this._layers=[];this._tiles=[];this._base=new canvasLayer(this._map)},addLayer:function(n){return this._layers.push(n),google.maps.event.trigger(this._map,"idle"),this._layers.length},addTile:function(n){return this._tiles.push(n),this._map.overlayMapTypes.insertAt(0,n),this._tiles.length},destroy:function(){K._base.setMap(null);K._base=null;K._layers=[];K._map=null},clean:function(){for(var n=0,t=K._layers.length;n<t;n++)K._pane.removeChild(K._layers[n]._canvas);K._layers=[]},removeLayer:function(n){this._pane.removeChild(this._layers[n]);this._layers.splice(n,1)},removetile:function(n){this._map.overlayMapTypes.removeAt(ix);this._tiles.splice(n,1)},showInfoBox:function(n,t,i){this._infobox!=null&&this._infobox.setMap(null);i<7&&(i=7);i+=12;this._infobox=new InfoBox({boxClass:"infobox",content:"<div>"+n+"<\/div>",position:t,disableAutoPan:!1,pixelOffset:new google.maps.Size(0,i),zIndex:null,closeBoxMargin:"12px 4px 2px 2px",closeBoxURL:"http://www.google.com/intl/en_us/mapfiles/close.gif",infoBoxClearance:new google.maps.Size(1,1),alignBottom:!0});this._infobox.open(this._map)},Layer:function(n,t){this.points=[];this.style=t;this.visible=!0;this.type="layer";this.name=n;this.addPoint=function(n){this.points.push(n)};this.addRange=function(n){for(var i=this._points,t=0,r=n.length;t<r;t++)i.push(n[t])};this.set=function(n,t){if(typeof n=="object")for(var i in n)this[i]=n[i];else this[n]=t;return this};this.onClick=function(n){var t="";for(var i in n)t+="<p><b>"+i+":<\/b> "+n[i]+"<\/p>";K.showInfoBox(t,n.geo,this.style.pointSize/2)}},Tile:function(n,t){var i=new google.maps.ImageMapType({getTileUrl:function(n,i){return n=getNormalizedCoord(n,i),"/tiles/"+i+"/"+n.x+"/"+n.y+"/"+t},tileSize:new google.maps.Size(256,256),name:name});return i.type="tile",i},Point:function(n,t,i){if(this.geo=new google.maps.LatLng(n,t),i)for(var r in i)this[r]=i[r]},_click:function(n){var i,h;if(!(this._layerOver<0)){var t=K._layers[this._layerOver],e=n.latLng.lat(),o=n.latLng.lng(),s=t.style.pointSize*t.style.pointSize,r=null;for(i=0,h=t.points.length;i<h;i++){var u=t.points[i],c=u.geo.lat(),l=u.geo.lng(),f=(e-c)*(e-c)+(o-l)*(o-l);if(f<s&&(s=f,r=u,f==0))break}if(r!=null)t.onClick(r)}},_draw:function(n){var i=n.getProjection(),f,v,t,y;if(i!==undefined){var b=K._map,s=n.map.getBounds(),c=n.map.getZoom(),r=i.fromLatLngToDivPixel(s.getSouthWest()),u=i.fromLatLngToDivPixel(s.getNorthEast()),l=Math.round(u.x-r.x),a=Math.round(r.y-u.y),p=Math.round(r.x)+"px",w=Math.round(u.y)+"px";for(f=0,v=K._layers.length;f<v;f++){K._layers[f]._canvas===undefined&&(t=document.createElement("canvas"),t.style.position="absolute",K._pane.appendChild(t),K._layers[f]._canvas=t);var h=K._layers[f],e=h.style,t=h._canvas,o=document.createElement("canvas");if(t.style.left=p,t.style.top=w,t.width=l,t.height=a,o.width=l,o.height=a,e.alpha<=0)return;e.type=="gradient"?K.drawGradient(e,o,h.points,s,i,r,u,c):e.type=="simpleheat"?K.drawSimpleHeat(e,h.points,o,s,i,r,u,c):K.drawDot(e,h.points,o,s,i,r,u);y=t.getContext("2d");y.drawImage(o,0,0)}}},_move:function(n){for(var r,f,i=-1,u=K._layers,t=u.length-1;t>=0;t--)if(r=u[t]._canvas,r!=null&&(f=r.getContext("2d").getImageData(n.pixel.x,n.pixel.y,1,1).data,f[3]>0)){i=t;break}this._layerOver=i;this.setOptions({draggableCursor:i>=0?"pointer":""})},drawSimpleHeat:function(n,t,i,r,u,f,e){for(var it,k,h,d,ut,lt,at,ft,o,v,s,g,nt,et=i.getContext("2d"),c=i.width,y=i.height,ot=et.getImageData(0,0,c,y),p=new Uint32Array(ot.data.buffer),st=n.pointSize,l=st/2,vt=l*l,bt=n.alpha,kt=K.drawing.getGradientPow(n.fillColor,n.borderColor,st),yt=f.x,pt=e.y,a=0,ht=0,tt=0,wt=t.length;tt<wt;tt++)if(it=t[tt].geo,r.contains(it)){var ct=u.fromLatLngToDivPixel(it),w=Math.round(ct.x-yt),b=Math.round(ct.y-pt),rt=Math.round(w-l);for(rt<0&&(rt=0),k=Math.round(w+l),k>=c&&(k=c-1),h=Math.round(b-l),h<0&&(h=0),d=Math.round(b+l),d>=y&&(d=y-1);h<d;){for(ut=h*c,o=rt;o<k;o++)lt=(o-w)*(o-w)+(h-b)*(h-b),lt<=vt&&(s=p[ut+o]+1,s>a?a=s:s>ht&&(ht=s),p[ut+o]=s);h++}}for(at=K.drawing.createPattern([{r:0,g:0,b:255},{r:0,g:255,b:255},{r:0,g:255,b:0},{r:255,g:255,b:0},{r:255,g:0,b:0}],a),points=y;points--;)for(ft=points*c,o=c;o--;)v=p[ft+o],v!==0&&(s=Math.round(v*255/a),g=Math.round(v*50/a),s>255&&(s=255),g>50&&(g=50),nt=at[v],p[ft+o]=150+g<<24|nt.b<<16|nt.g<<8|nt.r);et.putImageData(ot,0,0)},drawGradient:function(n,t,i,r,u,f,e,o){var nt=n.pointSize,y,st,p,it,l,w,b,s,k,rt,h,a,d,g;this.zoomadjust_&&o<=3&&(nt=3);var ut=t.getContext("2d"),v=t.width,tt=t.height,ft=ut.getImageData(0,0,v,tt),et=new Uint32Array(ft.data.buffer),c=nt/2,ht=c*c,ot=n.alpha,ct=K.drawing.getGradientPow(n.fillColor,n.borderColor,nt),lt=f.x,at=e.y;for(y=0,st=i.length;y<st;y++)if(p=i[y].geo,p!=null&&r.contains(p))for(it=u.fromLatLngToDivPixel(p),l=Math.round(it.x-lt),ypos=Math.round(it.y-at),w=Math.round(l-c),w<0&&(w=0),b=Math.round(l+c),b>=v&&(b=v-1),s=Math.round(ypos-c),s<0&&(s=0),k=Math.round(ypos+c),k>=tt&&(k=tt-1);s<k;){for(rt=s*v,h=w;h<b;h++)a=(h-l)*(h-l)+(s-ypos)*(s-ypos),a<=ht&&(d=ct[a],g=et[rt+h],(g===0||g!==0&&g>>>24<ot-a)&&(et[rt+h]=ot-a<<24|d.b<<16|d.g<<8|d.r));s++}ut.putImageData(ft,0,0)},drawDot:function(n,t,i,r,u,f,e){var o=n.pointSize,s,l,h,c;n.zoomadjust&&(zoomlevel>=19?o=o*4:zoomlevel==18?o=o*3:zoomlevel==17?o=o*2:zoomlevel==16?o=Math.round(o*1.5):zoomlevel<=3&&(o=3));var a=K.drawing.createDot(n.type,n.fillColor.hex,n.borderColor.hex,o,n.alpha),v=f.x+o/2,y=e.y+o/2,p=i.getContext("2d");for(s=0,l=t.length;s<l;s++)h=t[s].geo,r.contains(h)&&(c=u.fromLatLngToDivPixel(h),p.drawImage(a,Math.round(c.x-v),Math.round(c.y-y)))},drawGradientDot:function(n,t,i,r,u,f,e){var s=document.createElement("canvas"),o,h,l,c;s.width=n.pointSize;s.height=n.pointSize;o=s.getContext("2d");o.globalAlpha=n.alpha/255;o.beginPath();o.arc(n.pointSize/2,n.pointSize/2,n.pointSize/2,0,2*Math.PI,!1);o.fillStyle=n.fillColor.hex;o.fill();o.lineWidth=1;o.strokeStyle=n.borderColor.hex;o.stroke();var v=f.x+Math.round(n.pointSize/2),y=e.y+Math.round(n.pointSize/2),p=i.getContext("2d");for(h=0,l=t.length;h<l;h++)if(c=t[h].geo,r.contains(c)){var a=u.fromLatLngToDivPixel(c),w=Math.round(a.x-v),b=Math.round(a.y-y);p.drawImage(s,w,b)}},drawing:{getGradient:function(n,t,i){var r;typeof n=="string"&&(n=this.hexToRgb(n));typeof t=="string"&&(t=this.hexToRgb(t));var u=Math.round(i/2),h=(t.r-n.r)/u,c=(t.g-n.g)/u,l=(t.b-n.b)/u,f=[];for(r=0;r<=u;r++){var e=Math.round(n.r+h*r),o=Math.round(n.g+c*r),s=Math.round(n.b+l*r);f.push({r:e,g:o,b:s,hex:"#"+this.toHex(e)+this.toHex(o)+this.toHex(s)})}return f},getGradientPow:function(n,t,i){for(var u=Math.round(i*i/4),h=(t.r-n.r)/u,c=(t.g-n.g)/u,l=(t.b-n.b)/u,f=[],r=0;r<=u;r++){var e=Math.round(n.r+h*r),o=Math.round(n.g+c*r),s=Math.round(n.b+l*r);f.push({r:e,g:o,b:s,hex:"#"+this.toHex(e)+this.toHex(o)+this.toHex(s)})}return f},createPattern:function(n,t){for(var r,s,u=[],f=Math.round(t/(n.length-1)),e=0,h=n.length-1;e<h;e++){var i=n[e],o=n[e+1],c=(o.r-i.r)/f,l=(o.g-i.g)/f,a=(o.b-i.b)/f;for(r=0;r<=f;r++){var v=Math.round(i.r+c*r),y=Math.round(i.g+l*r),p=Math.round(i.b+a*r);u.push({r:v,g:y,b:p})}}for(s=n[n.length-1];u.length<t;)u.push(s);return u},toHex:function(n){return n=n.toString(16),n.length==1&&(n="0"+n),n},hexToRgb:function(n){var t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(n);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16),hex:n}:null},invertColor:function(n){return n[0]=="#"&&(n=n.substring(1)),n=parseInt(n,16),n=16777215^n,n=n.toString(16),n=("000000"+n).slice(-6),"#"+n},createDot:function(n,t,i,r,u,f){var o,e;if(n=="scatter"){if(f>1)return this.createScatterDot(t,i,r,u,f);n="plain"}o=document.createElement("canvas");o.width=r;o.height=r;e=o.getContext("2d");switch(n){case"shadow":e.globalAlpha=u/510;e.beginPath();e.arc(r/2,r/2,r/2,0,2*Math.PI,!1);e.fillStyle=t;e.fill();e.globalAlpha=u/255;e.beginPath();e.arc(r/2,r/2,r/4,0,2*Math.PI,!1);e.fillStyle=t;e.fill();e.lineWidth=1;e.strokeStyle=i;e.stroke();break;case"plain":e.globalAlpha=u/255;e.beginPath();e.arc(r/2,r/2,r/2,0,2*Math.PI,!1);e.fillStyle=t;e.fill();e.lineWidth=1;e.strokeStyle=i;e.stroke()}return o},createScatterDot:function(n,t,i,r,u){for(var e=this.getGradient(n,t,u*2),o=[],f=0,s=e.length;f<s;f++)o.push(this.createDot("plain",e[f].hex,this.invertColor(e[f].hex),i,r));return o}}};
