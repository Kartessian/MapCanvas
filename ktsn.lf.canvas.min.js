window.K={init:function(n){n.map?this._map=n.map:(L.mapbox.accessToken=n.token,this._map=L.mapbox.map(n.div,n.key).setView([0,0],3));this._pane=null;this._layers=[];this._base=new this.baseLayer;this._map.addLayer(this._base)},baseLayer:L.Class.extend({initialize:function(){},onAdd:function(n){for(var t,r=n.getPanes().overlayPane,i=0,u=K._layers.length;i<u;i++)t=document.createElement("canvas"),t.style.position="absolute",r.appendChild(t),K._layers[i]._canvas=t;K._pane=r;this._moveend=n.on("moveend",K._draw,this);this._mousemove=n.on("mousemove",K._move,this);this._click=n.on("click",K._click,this)},onRemove:function(n){for(var i=K._pane,t=0,r=K._layers.length;t<r;t++)i.removeChild(K._layers[t]._canvas);n.off("moveend",K._draw,this);this._moveend=null;n.off("mousemove",K._move,this);this._mousemove=null;n.off("click",K._move,this);this._click=null}}),addLayer:function(n){return this._layers.push(n),this._draw(),this._layers.length},destroy:function(){K._base.onRemove(K._map);K._layers=[]},removeLayer:function(n){this._pane.removeChild(this._layers[n]);this._layers.splice(n,1)},Layer:function(n,t){this.points=[];this.style=t;this.visible=!0;this.name=n;this.addPoint=function(n){this.points.push(n)};this.addRange=function(n){for(var i=this._points,t=0,r=n.length;t<r;t++)i.push(n[t])};this.set=function(n,t){if(typeof n=="object")for(var i in n)this[i]=n[i];else this[n]=t;return this}},Point:function(n,t,i){if(this.geo=L.latLng(n,t),i)for(var r in i)this[r]=i[r]},_click:function(){var t,n,i,r;if(!(this._layerOver<0))for(t=K._layers[this._layerOver],n=0,i=t.points.length;n<i;n++)r=t.points[n]},_draw:function(){var u,a,n,v;if(K._map!==undefined){var t=K._map,o=t.getBounds(),h=t.getZoom(),i=t.latLngToLayerPoint(o._southWest),r=t.latLngToLayerPoint(o._northEast),c=Math.round(r.x-i.x),l=Math.round(i.y-r.y),y=Math.round(i.x)+"px",p=Math.round(r.y)+"px";for(u=0,a=K._layers.length;u<a;u++){K._layers[u]._canvas===undefined&&(n=document.createElement("canvas"),n.style.position="absolute",K._pane.appendChild(n),K._layers[u]._canvas=n);var s=K._layers[u],f=s.style,n=s._canvas,e=document.createElement("canvas");if(n.style.left=y,n.style.top=p,n.width=c,n.height=l,e.width=c,e.height=l,f.alpha<=0)return;f.type=="gradient"?K.drawGradient(f,e,s.points,o,t,i,r,h):f.type=="simpleheat"?K.drawSimpleHeat(f,s.points,e,o,t,i,r,h):K.drawDot(f,s.points,e,o,t,i,r);v=n.getContext("2d");v.drawImage(e,0,0)}}},_move:function(n){for(var r,e,u=n.containerPoint,i=-1,f=K._layers,t=f.length-1;t>=0;t--)if(r=f[t]._canvas,r!=null&&(e=r.getContext("2d").getImageData(u.x,u.y,1,1).data,e[3]>0)){i=t;break}this._layerOver=i;n.target._container.style.cursor=i>=0?"pointer":null},drawSimpleHeat:function(n,t,i,r,u,f,e){for(var it,k,h,d,ut,lt,at,ft,o,v,s,g,nt,et=i.getContext("2d"),c=i.width,y=i.height,ot=et.getImageData(0,0,c,y),p=new Uint32Array(ot.data.buffer),st=n.pointSize,l=st/2,vt=l*l,bt=n.alpha,kt=drawing.getGradientPow(n.fillColor,n.borderColor,st),yt=f.x,pt=e.y,a=0,ht=0,tt=0,wt=t.length;tt<wt;tt++)if(it=t[tt].geo,r.contains(it)){var ct=u.latLngToLayerPoint(it),w=Math.round(ct.x-yt),b=Math.round(ct.y-pt),rt=Math.round(w-l);for(rt<0&&(rt=0),k=Math.round(w+l),k>=c&&(k=c-1),h=Math.round(b-l),h<0&&(h=0),d=Math.round(b+l),d>=y&&(d=y-1);h<d;){for(ut=h*c,o=rt;o<k;o++)lt=(o-w)*(o-w)+(h-b)*(h-b),lt<=vt&&(s=p[ut+o]+1,s>a?a=s:s>ht&&(ht=s),p[ut+o]=s);h++}}for(at=drawing.createPattern([{r:0,g:0,b:255},{r:0,g:255,b:255},{r:0,g:255,b:0},{r:255,g:255,b:0},{r:255,g:0,b:0}],a),points=y;points--;)for(ft=points*c,o=c;o--;)v=p[ft+o],v!==0&&(s=Math.round(v*255/a),g=Math.round(v*50/a),s>255&&(s=255),g>50&&(g=50),nt=at[v],p[ft+o]=150+g<<24|nt.b<<16|nt.g<<8|nt.r);et.putImageData(ot,0,0)},drawGradient:function(n,t,i,r,u,f,e,o){var nt=n.pointSize,y,st,p,it,l,w,b,s,k,rt,h,a,d,g;this.zoomadjust_&&o<=3&&(nt=3);var ut=t.getContext("2d"),v=t.width,tt=t.height,ft=ut.getImageData(0,0,v,tt),et=new Uint32Array(ft.data.buffer),c=nt/2,ht=c*c,ot=n.alpha,ct=drawing.getGradientPow(n.fillColor,n.borderColor,nt),lt=f.x,at=e.y;for(y=0,st=i.length;y<st;y++)if(p=i[y].geo,p!=null&&r.contains(p))for(it=u.latLngToLayerPoint(p),l=Math.round(it.x-lt),ypos=Math.round(it.y-at),w=Math.round(l-c),w<0&&(w=0),b=Math.round(l+c),b>=v&&(b=v-1),s=Math.round(ypos-c),s<0&&(s=0),k=Math.round(ypos+c),k>=tt&&(k=tt-1);s<k;){for(rt=s*v,h=w;h<b;h++)a=(h-l)*(h-l)+(s-ypos)*(s-ypos),a<=ht&&(d=ct[a],g=et[rt+h],(g===0||g!==0&&g>>>24<ot-a)&&(et[rt+h]=ot-a<<24|d.b<<16|d.g<<8|d.r));s++}ut.putImageData(ft,0,0)},drawDot:function(n,t,i,r,u,f,e){var o=n.pointSize,s,l,h,c;n.zoomadjust&&(zoomlevel>=19?o=o*4:zoomlevel==18?o=o*3:zoomlevel==17?o=o*2:zoomlevel==16?o=Math.round(o*1.5):zoomlevel<=3&&(o=3));var a=drawing.createDot(n.type,n.fillColor.hex,n.borderColor.hex,o,n.alpha),v=f.x+o/2,y=e.y+o/2,p=i.getContext("2d");for(s=0,l=t.length;s<l;s++)h=t[s].geo,r.contains(h)&&(c=u.latLngToLayerPoint(h),p.drawImage(a,Math.round(c.x-v),Math.round(c.y-y)))},drawGradientDot:function(n,t,i,r,u,f,e){var s=document.createElement("canvas"),o,h,l,c;s.width=n.pointSize;s.height=n.pointSize;o=s.getContext("2d");o.globalAlpha=n.alpha/255;o.beginPath();o.arc(n.pointSize/2,n.pointSize/2,n.pointSize/2,0,2*Math.PI,!1);o.fillStyle=n.fillColor.hex;o.fill();o.lineWidth=1;o.strokeStyle=n.borderColor.hex;o.stroke();var v=f.x+Math.round(n.pointSize/2),y=e.y+Math.round(n.pointSize/2),p=i.getContext("2d");for(h=0,l=t.length;h<l;h++)if(c=t[h].geo,r.contains(c)){var a=u.latLngToLayerPoint(c),w=Math.round(a.x-v),b=Math.round(a.y-y);p.drawImage(s,w,b)}}};
